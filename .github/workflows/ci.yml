##############################
####  AUTOGENERATED       ####
####  DO NOT MODIFY!      ####
##############################
# Workflow for PR checks in module repositories
name: CI

on:
  # Start workflow on each pull request
  pull_request:

concurrency:
  # There should be only one in-progress run of this workflow at a time for a specific PR
  group: ${{ github.event.number }}
  # Cancel runs of this workflow that are currently in progess.
  cancel-in-progress: true

jobs:
  # Runs the unit test suite
  unit-tests:
    name: Run unit test suite
    # Define plenty-used variables
    env:
      # CI variables
      APP_ENV: testing
      IS_JENKINS: true
      PLENTY_ID_HASH: 1000
      WORKSPACE: ${{ github.workspace }}
      INC_DIR: ${{ github.workspace }}/pl/packages/plentymarkets/plugin-test-suite/tests/includes
      TEST_SUITE_DIR: ${{ github.workspace }}/pl/packages/plentymarkets/plugin-test-suite

      # Database variables
      DB_HOST: "127.0.0.1"
      DB_USERNAME: root
      DB_PASSWORD: test
      DB_DATABASE: mysql-test
      # Synonym database variable names (only defined because of inconsistency within plenty code)
      DB_USER: root
      DB_PASS: test
      DB_NAME: mysql-test

      # AWS environment variables
      AWS_REGION: eu-central-1
    strategy:
      fail-fast: false
      matrix:
        php:
          - version: "8.0"
            required: true
          - version: "8.2"
            required: true

    runs-on: ubuntu-latest

    # Start containers with specific services that are needed to run the unit test suite.
    # In this case we need mariadb and redis.
    # The used versions match the ones used in production.
    services:
      mariadb:
        # Uses a prewarmed db image here to speedup the migrations https://github.com/plentymarkets/prewarm-db
        image: ghcr.io/plentymarkets/prewarm-db:stable7
        credentials:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.PUBLIC_PAT_CICD4_PUBLIC }}
        ports:
          - 127.0.0.1:3306:3306
        env:
          MARIADB_ROOT_PASSWORD: ${{ env.DB_PASSWORD }}
          MARIADB_DATABASE: ${{ env.DB_DATABASE }}
      redis:
        image: redis:4.0.8
        ports:
          - 127.0.0.1:6379:6379

    steps:
      - name: Cleanup Runner
        uses: plentymarkets/github-runner-cleanup@main

      - name: Checkout github-actions repository
        uses: actions/checkout@v3
        with:
          repository: plentymarkets/github-actions
          ref: main
          token: ${{ secrets.PUBLIC_PAT_CICD4_PUBLIC }}
          path: .tmp/github-actions

      - name: Checkout PL PY PS
        id: branches
        uses: ./.tmp/github-actions/checkout_pl_py_ps/
        with:
          token: ${{ secrets.PUBLIC_PAT_CICD4_PUBLIC }}
          ref-forced: stable7

      # Cache dependencies to reduce traffic and cpu usage
      - name: Cache pl dependencies
        uses: actions/cache@v3
        with:
          path: "pl/vendor"
          restore-key: composer-pl-stable7
      # Install dependencies
      - name: Install dependencies
        # Change the path of the working directory to prevent running below script(s) in the workflow's working directory
        working-directory: pl
        # Remove locally stored Laravel files if they exist
        # Execute composer install without executing scripts defined in 'composer.json'
        # Search for modules
        # Enable OpenSSL OAuth encryption
        # Create an empty '.env' file ('autoloader' requires this file, even if it is empty)
        run: |
          rm -f bootstrap/cache/{services,packages}.php
          composer update --no-progress --no-scripts
          php artisan package:discover
          php artisan passport:keys 
          touch .env
      # Prepare the test database
      - name: Init db
        working-directory: pl
        run: |
          php artisan migrate --database=mysql-test --env=testing
          php artisan db:seed --database=mysql-test --env=testing
      - name: Build plugin api
        working-directory: pl
        run: |
          composer dump-autoload
          php artisan plugin:buildinterface --without-docs --target=./storage/plugin-interface
      - name: Checkout plugin test suite
        uses: actions/checkout@v3
        with:
          repository: "plentymarkets/plugin-test-suite"
          token: ${{ secrets.PUBLIC_PAT_CICD4_PUBLIC }}
          path: "pl/packages/plentymarkets/plugin-test-suite/"
          ref: stable7
      - name: Install test suite dependencies
        working-directory: pl/packages/plentymarkets/plugin-test-suite
        run: |
          composer install
          rm .env
          touch .env
      - name: Checkout IO branch
        uses: actions/checkout@v3
        with:
          path: pl/packages/plentymarkets/plugin-test-suite/vendor/plentymarkets/plugin-io
      - name: Run plugin migrations
        working-directory: pl
        run: php artisan plugin:install --database=mysql-test --env=testing
      - name: Run tests
        working-directory: pl/packages/plentymarkets/plugin-test-suite
        run: vendor/bin/phpunit vendor/plentymarkets/plugin-io
